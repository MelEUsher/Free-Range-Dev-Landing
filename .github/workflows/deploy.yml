name: CI/CD + Lighthouse Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '**/*.json'
      - 'README'
      - 'README.md'
      - 'public/**'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.gif'
      - '**/*.svg'
      - '**/*.webp'
      - '**/*.avif'
      - '**/*.ico'

jobs:
  build-and-audit:
    name: Build + Lighthouse CI
    runs-on: ubuntu-latest

    if: >
      !contains(join(github.event.head_commit.message, ' '), '[skip ci]') &&
      !endsWith(github.ref, '/skip')

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v6

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build Next.js app
        run: npm run build

      - name: üåç Start server in background
        run: |
          PORT=4000 npm run start &
          sleep 8

      - name: Warm Next.js cache
        run: |
          echo "Warming cache‚Ä¶"

          # Warm homepage
          curl -s http://localhost:4000/ > /dev/null

          # Warm CSS bundles
          for css in $(ls .next/static/css/*.css 2>/dev/null); do
            curl -s http://localhost:4000/_next/static/css/$(basename $css) > /dev/null || true
          done

          # Warm JS chunks
          for js in $(ls .next/static/chunks/*.js 2>/dev/null); do
            curl -s http://localhost:4000/_next/static/chunks/$(basename $js) > /dev/null || true
          done

          # Warm LCP image
          curl -s "http://localhost:4000/_next/image?url=/assets/Image%20saved%20for%20website%20use.svg&w=2048&q=75" > /dev/null || true

      - name: üîç Run Lighthouse CI (Desktop)
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: .lighthouserc.desktop.json
          temporaryPublicStorage: true

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: lighthouse-report
          path: .lighthouseci/desktop